# SignalFriend Backend Development Tracker
# Created: 2024-11-30
# Branch: feature/backend-setup

================================================================================
## PHASE 1: Project Setup ✅
================================================================================
[x] Create feature branch (feature/backend-setup)
[x] Initialize backend folder structure
[x] Create package.json with dependencies
[x] Create tsconfig.json
[x] Create .env.example
[x] Set up ESLint + Prettier configs

================================================================================
## PHASE 2: Shared Infrastructure ✅
================================================================================
[x] src/shared/config/env.ts - Environment variables with Zod validation
[x] src/shared/config/database.ts - MongoDB connection with Mongoose
[x] src/shared/config/logger.ts - Pino logger setup
[x] src/shared/middleware/security.ts - Helmet, CORS config
[x] src/shared/middleware/rateLimiter.ts - Express rate limiting
[x] src/shared/middleware/errorHandler.ts - Global error handler
[x] src/shared/middleware/validation.ts - Zod validation middleware
[x] src/shared/middleware/auth.ts - JWT verification middleware
[x] src/shared/utils/ApiError.ts - Custom error class
[x] src/shared/utils/asyncHandler.ts - Async route wrapper
[x] src/shared/types/api.types.ts - API response types
[x] src/shared/types/common.types.ts - Shared types (Address, etc.)

================================================================================
## PHASE 3: Contract Integration ✅
================================================================================
[x] src/contracts/addresses.ts - Contract addresses by chainId
[x] src/contracts/clients.ts - Viem public client setup
[x] src/contracts/abis/ - Extracted ABIs from Foundry build output

================================================================================
## PHASE 4: MongoDB Models ✅
================================================================================
[x] src/features/predictors/predictor.model.ts
[x] src/features/signals/signal.model.ts
[x] src/features/receipts/receipt.model.ts
[x] src/features/reviews/review.model.ts
[x] src/features/categories/category.model.ts

================================================================================
## PHASE 5: Authentication Feature (SIWE + JWT) ✅
================================================================================
[x] src/features/auth/auth.schemas.ts - Zod schemas (nonce, verify)
[x] src/features/auth/auth.service.ts - SIWE verify, JWT sign/verify
[x] src/features/auth/auth.controller.ts - getNonce, verify, logout
[x] src/features/auth/auth.routes.ts - POST /auth/nonce, /auth/verify
[x] src/features/auth/auth.types.ts - Auth-specific types

================================================================================
## PHASE 6: Webhook Feature (Alchemy Event Indexing) ✅
================================================================================
[x] src/features/webhooks/webhook.schemas.ts - Alchemy webhook payload
[x] src/features/webhooks/webhook.service.ts - Event handlers with viem decoding
[x] src/features/webhooks/webhook.controller.ts - Process events
[x] src/features/webhooks/webhook.routes.ts - POST /webhooks/alchemy
[x] Event signature generation (PredictorJoined, SignalPurchased, PredictorBlacklisted)
[x] viem decodeEventLog integration with contract ABIs
[x] src/shared/services/blockchain.service.ts - On-chain verification utilities
[x] Set up Alchemy Custom (GraphQL) Webhook in Dashboard
[x] GraphQL webhook payload support (discriminated union schema)
[x] ContentId format conversion (UUID ↔ bytes32)
[x] src/shared/utils/contentId.ts - uuidToBytes32, bytes32ToUuid
[x] SignalService.getContentIdentifier() - For frontend to get bytes32
[x] Tested PredictorJoined event → Creates Predictor in MongoDB
[x] Tested SignalPurchased event → Creates Receipt in MongoDB
[x] Tested PredictorBlacklisted event → Updates Predictor.isBlacklisted

================================================================================
## PHASE 7: Core Features
================================================================================

### Predictors Feature ✅
[x] src/features/predictors/predictor.schemas.ts
[x] src/features/predictors/predictor.service.ts
[x] src/features/predictors/predictor.controller.ts
[x] src/features/predictors/predictor.routes.ts

### Signals Feature ✅
[x] src/features/signals/signal.schemas.ts
[x] src/features/signals/signal.service.ts
[x] src/features/signals/signal.controller.ts
[x] src/features/signals/signal.routes.ts

### Receipts Feature ✅
[x] src/features/receipts/receipt.schemas.ts
[x] src/features/receipts/receipt.service.ts
[x] src/features/receipts/receipt.controller.ts
[x] src/features/receipts/receipt.routes.ts

### Reviews Feature ✅ (Simplified to Rating-Only)
[x] src/features/reviews/review.schemas.ts
[x] src/features/reviews/review.service.ts
[x] src/features/reviews/review.controller.ts
[x] src/features/reviews/review.routes.ts
[x] Simplified to rating-only (removed reviewText field)
[x] Verified review validation (checks Receipt ownership via tokenId)
[x] Clarified ratings are off-chain only (no markSignalRated on-chain)

### Reports Feature ✅ (NEW - Scam/False Signal Reporting)
[x] src/features/reports/report.model.ts - MongoDB model with status workflow
[x] src/features/reports/report.schemas.ts - Zod validation schemas
[x] src/features/reports/report.service.ts - Business logic (create, list, stats)
[x] src/features/reports/report.controller.ts - Express request handlers
[x] src/features/reports/report.routes.ts - API route definitions
[x] Report reasons: false_signal, misleading_info, scam, duplicate_content, other
[x] Status workflow: pending → reviewed → resolved/dismissed
[x] One report per purchase (unique tokenId constraint)
[x] Report validation (requires Receipt ownership)

### Categories Feature ✅
[x] src/features/categories/category.schemas.ts
[x] src/features/categories/category.service.ts
[x] src/features/categories/category.controller.ts
[x] src/features/categories/category.routes.ts
[x] Database seed script for initial categories

================================================================================
## PHASE 8: Main App Entry ✅
================================================================================
[x] src/index.ts - Express app setup, route mounting
[x] Health check endpoint
[x] Graceful shutdown handling

================================================================================
## PHASE 9: Testing ⏳
================================================================================
[x] vitest.config.ts
[x] tests/setup.ts - Test database setup
[ ] Unit tests for services
[ ] Integration tests for routes

================================================================================
## PHASE 10: Network Configuration ✅
================================================================================
[x] CHAIN_ID env variable (97=testnet, 56=mainnet)
[x] Network helper functions (isTestnet, isMainnet, getNetworkName)
[x] Mainnet address validation (throws if zeros)
[x] Simplified .env (removed contract addresses)
[x] Contract addresses in addresses.ts (single source of truth)
[x] Official BSC USDT address pre-configured for mainnet

================================================================================
## PHASE 10.5: Predictor Enhancements ✅
================================================================================
[x] Added preferredContact field to Predictor model (telegram | discord)
[x] Updated predictor.schemas.ts to allow updating preferredContact
[x] Added MIN_SIGNAL_PRICE_USDT env variable (default: 5)
[x] Updated signal.schemas.ts to use env variable for validation
[x] Added earnings endpoint GET /api/predictors/:address/earnings
[x] Updated predictor.service.ts with getEarnings() method
[x] Updated predictor.controller.ts with getPredictorEarnings handler
[x] Updated predictor.routes.ts with earnings route

================================================================================
## PHASE 10.6: Admin Features ✅
================================================================================
[x] Added ADMIN_ADDRESSES env variable (comma-separated MultiSig wallets)
[x] Created admin middleware (src/shared/middleware/admin.ts)
    - isAdmin(address) helper function
    - requireAdmin middleware for protected routes
[x] Hidden sensitive contact info from public API responses
    - telegram, discord, preferredContact hidden from regular users
    - Only twitter visible to public
[x] Admin can view any signal's protected content (bypass in getProtectedContent)
[x] Created admin feature module (src/features/admin/)
    - admin.controller.ts - Request handlers
    - admin.routes.ts - Route definitions
    - index.ts - Module exports
[x] Admin endpoints:
    - GET /api/admin/predictors/:address - Full predictor info with contacts
    - POST /api/admin/predictors/:address/blacklist - Blacklist in DB
    - POST /api/admin/predictors/:address/unblacklist - Remove blacklist in DB
    - DELETE /api/admin/signals/:contentId - Deactivate signal (soft delete)
[x] Added adminDeactivate() to signal.service.ts
[x] Added getByAddressAdmin(), adminBlacklist(), adminUnblacklist() to predictor.service.ts
[x] Updated .env.example with admin addresses documentation
[x] Mounted admin routes at /api/admin in src/index.ts

================================================================================
## PHASE 10b: Predictor Verification System ✅
================================================================================
[x] Added verification fields to Predictor model:
    - isVerified (boolean) - Has verified badge
    - verificationStatus ('none' | 'pending' | 'rejected')
    - salesAtLastApplication (number) - For re-apply logic
    - verificationAppliedAt (Date) - When applied
    - displayNameChanged (boolean) - Locked after first change
[x] Display name restrictions:
    - Can only be changed ONCE, then locked forever
    - Must be unique (case-insensitive)
    - Added unique index with collation
[x] Avatar restrictions:
    - Only verified predictors can set avatarUrl
    - Unverifying removes avatar automatically
[x] Verification endpoints:
    - POST /api/predictors/:address/apply-verification (predictor, 100+ sales)
    - GET /api/admin/verification-requests (admin, list pending)
    - POST /api/admin/predictors/:address/verify (admin, approve)
    - POST /api/admin/predictors/:address/reject (admin, reject)
    - POST /api/admin/predictors/:address/unverify (admin, remove badge)
[x] Re-apply logic:
    - Need 100 more sales after rejection to re-apply

================================================================================
## PHASE 11: Deployment Prep
================================================================================
[ ] Dockerfile
[ ] docker-compose.yml (with MongoDB)
[ ] Production environment variables
[ ] MongoDB Atlas setup guide

================================================================================
## NOTES
================================================================================
- Contract Addresses (BNB Testnet - Chain ID 97):
  - MockUSDT: 0xF87d17a5ca95F3f992f82Baabf4eBC5301A178a5
  - SignalFriendMarket: 0x5133397a4B9463c5270beBa05b22301e6dD184ca
  - PredictorAccessPass: 0x10EB1A238Db78b763ec97e326b800D7A7AcA3fC4
  - SignalKeyNFT: 0xfb26Df6101e1a52f9477f52F54b91b99fb016aed

- Alchemy Webhook Setup (Completed with GraphQL):
  1. Go to Alchemy Dashboard → Webhooks → Create Webhook
  2. Select "Custom Webhook" (GraphQL) for richer data
  3. Add SignalFriendMarket address: 0x5133397a4B9463c5270beBa05b22301e6dD184ca
  4. Add PredictorAccessPass address: 0x10EB1A238Db78b763ec97e326b800D7A7AcA3fC4
  5. Set webhook URL: https://your-ngrok-url.ngrok-free.dev/api/webhooks/alchemy
  6. Copy signing key to ALCHEMY_SIGNING_KEY env var

- ContentId Conversion (UUID ↔ bytes32):
  - Backend uses UUID: 00000000-0000-0000-0000-000000000001
  - Smart contract uses bytes32: 0x0000000000000000000000000000000100000000...
  - Use SignalService.getContentIdentifier() for frontend

- USDT on BNB Chain uses 18 decimals (not 6 like Ethereum!)
